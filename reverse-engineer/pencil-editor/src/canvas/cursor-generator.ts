import * as platform from "../platform";
import * as math from "../utils/math";

const resizeHandleCursor = `
<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<mask id="path-1-outside-1_19_316" maskUnits="userSpaceOnUse" x="1.75" y="6.46973" width="20" height="12" fill="black">
<rect fill="white" x="1.75" y="6.46973" width="20" height="12"/>
<path d="M20.75 12C20.75 12.1989 20.6709 12.3896 20.5303 12.5303L16.5303 16.5303L15.4697 15.4697L18.1895 12.75L5.81055 12.75L8.53027 15.4697L7.46973 16.5303L3.46973 12.5303C3.32908 12.3896 3.25001 12.1989 3.25 12C3.25 11.8011 3.32908 11.6104 3.46973 11.4697L7.46973 7.46973L8.53027 8.53027L5.81055 11.25L18.1895 11.25L15.4697 8.53027L16.5303 7.46973L20.5303 11.4697C20.6709 11.6104 20.75 11.8011 20.75 12Z"/>
</mask>
<path d="M20.75 12C20.75 12.1989 20.6709 12.3896 20.5303 12.5303L16.5303 16.5303L15.4697 15.4697L18.1895 12.75L5.81055 12.75L8.53027 15.4697L7.46973 16.5303L3.46973 12.5303C3.32908 12.3896 3.25001 12.1989 3.25 12C3.25 11.8011 3.32908 11.6104 3.46973 11.4697L7.46973 7.46973L8.53027 8.53027L5.81055 11.25L18.1895 11.25L15.4697 8.53027L16.5303 7.46973L20.5303 11.4697C20.6709 11.6104 20.75 11.8011 20.75 12Z" fill="black"/>
<path d="M20.75 12L21.75 12L21.75 12L20.75 12ZM20.5303 12.5303L21.2374 13.2374L21.2374 13.2374L20.5303 12.5303ZM16.5303 16.5303L15.8232 17.2374C16.2137 17.6279 16.8469 17.6279 17.2374 17.2374L16.5303 16.5303ZM15.4697 15.4697L14.7626 14.7626C14.3721 15.1531 14.3721 15.7863 14.7626 16.1768L15.4697 15.4697ZM18.1895 12.75L18.8966 13.4571C19.1826 13.1711 19.2681 12.741 19.1133 12.3673C18.9586 11.9936 18.5939 11.75 18.1895 11.75L18.1895 12.75ZM5.81055 12.75L5.81055 11.75C5.40608 11.75 5.04145 11.9936 4.88667 12.3673C4.73189 12.741 4.81744 13.1711 5.10344 13.4571L5.81055 12.75ZM8.53027 15.4697L9.23738 16.1768C9.6279 15.7863 9.6279 15.1531 9.23738 14.7626L8.53027 15.4697ZM7.46973 16.5303L6.76262 17.2374C7.15314 17.6279 7.78631 17.6279 8.17683 17.2374L7.46973 16.5303ZM3.46973 12.5303L2.76262 13.2374L2.76262 13.2374L3.46973 12.5303ZM3.25 12L2.25 12L2.25 12L3.25 12ZM3.46973 11.4697L2.76262 10.7626L2.76261 10.7626L3.46973 11.4697ZM7.46973 7.46973L8.17683 6.76262C7.78631 6.37209 7.15314 6.37209 6.76262 6.76262L7.46973 7.46973ZM8.53027 8.53027L9.23738 9.23738C9.6279 8.84686 9.6279 8.21369 9.23738 7.82317L8.53027 8.53027ZM5.81055 11.25L5.10344 10.5429C4.81744 10.8289 4.73189 11.259 4.88667 11.6327C5.04145 12.0064 5.40608 12.25 5.81055 12.25L5.81055 11.25ZM18.1895 11.25L18.1895 12.25C18.5939 12.25 18.9586 12.0064 19.1133 11.6327C19.2681 11.259 19.1826 10.8289 18.8966 10.5429L18.1895 11.25ZM15.4697 8.53027L14.7626 7.82317C14.3721 8.21369 14.3721 8.84686 14.7626 9.23738L15.4697 8.53027ZM16.5303 7.46973L17.2374 6.76262C16.8469 6.3721 16.2137 6.3721 15.8232 6.76262L16.5303 7.46973ZM20.5303 11.4697L21.2374 10.7626L21.2374 10.7626L20.5303 11.4697ZM20.75 12L19.75 12C19.75 11.9334 19.7765 11.8699 19.8232 11.8232L20.5303 12.5303L21.2374 13.2374C21.5654 12.9094 21.75 12.4644 21.75 12L20.75 12ZM20.5303 12.5303L19.8232 11.8232L15.8232 15.8232L16.5303 16.5303L17.2374 17.2374L21.2374 13.2374L20.5303 12.5303ZM16.5303 16.5303L17.2374 15.8232L16.1768 14.7626L15.4697 15.4697L14.7626 16.1768L15.8232 17.2374L16.5303 16.5303ZM15.4697 15.4697L16.1768 16.1768L18.8966 13.4571L18.1895 12.75L17.4823 12.0429L14.7626 14.7626L15.4697 15.4697ZM18.1895 12.75L18.1895 11.75L5.81055 11.75L5.81055 12.75L5.81055 13.75L18.1895 13.75L18.1895 12.75ZM5.81055 12.75L5.10344 13.4571L7.82317 16.1768L8.53027 15.4697L9.23738 14.7626L6.51765 12.0429L5.81055 12.75ZM8.53027 15.4697L7.82317 14.7626L6.76262 15.8232L7.46973 16.5303L8.17683 17.2374L9.23738 16.1768L8.53027 15.4697ZM7.46973 16.5303L8.17683 15.8232L4.17683 11.8232L3.46973 12.5303L2.76262 13.2374L6.76262 17.2374L7.46973 16.5303ZM3.46973 12.5303L4.17683 11.8232C4.22354 11.8699 4.25 11.9334 4.25 12L3.25 12L2.25 12C2.25001 12.4644 2.43462 12.9094 2.76262 13.2374L3.46973 12.5303ZM3.25 12L4.25 12C4.25 12.0666 4.22352 12.1301 4.17685 12.1768L3.46973 11.4697L2.76261 10.7626C2.43464 11.0906 2.25 11.5356 2.25 12L3.25 12ZM3.46973 11.4697L4.17683 12.1768L8.17683 8.17683L7.46973 7.46973L6.76262 6.76262L2.76262 10.7626L3.46973 11.4697ZM7.46973 7.46973L6.76262 8.17683L7.82317 9.23738L8.53027 8.53027L9.23738 7.82317L8.17683 6.76262L7.46973 7.46973ZM8.53027 8.53027L7.82317 7.82317L5.10344 10.5429L5.81055 11.25L6.51765 11.9571L9.23738 9.23738L8.53027 8.53027ZM5.81055 11.25L5.81055 12.25L18.1895 12.25L18.1895 11.25L18.1895 10.25L5.81055 10.25L5.81055 11.25ZM18.1895 11.25L18.8966 10.5429L16.1768 7.82317L15.4697 8.53027L14.7626 9.23738L17.4823 11.9571L18.1895 11.25ZM15.4697 8.53027L16.1768 9.23738L17.2374 8.17683L16.5303 7.46973L15.8232 6.76262L14.7626 7.82317L15.4697 8.53027ZM16.5303 7.46973L15.8232 8.17683L19.8232 12.1768L20.5303 11.4697L21.2374 10.7626L17.2374 6.76262L16.5303 7.46973ZM20.5303 11.4697L19.8232 12.1768C19.7765 12.1301 19.75 12.0666 19.75 12L20.75 12L21.75 12C21.75 11.5356 21.5654 11.0906 21.2374 10.7626L20.5303 11.4697Z" fill="white" mask="url(#path-1-outside-1_19_316)"/>
</svg>`;

const rotationHandleCursor = `
<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<mask id="path-1-outside-1_19_325" maskUnits="userSpaceOnUse" x="7.875" y="2.25" width="8" height="20" fill="black">
<rect fill="white" x="7.875" y="2.25" width="8" height="20"/>
<path d="M11.835 4.75C15.8871 8.68563 15.8871 15.3144 11.835 19.25L14.875 19.25L14.875 20.75L9.875 20.75C9.46079 20.75 9.125 20.4142 9.125 20L9.125 15L10.625 15L10.625 18.3291C14.2904 14.9466 14.2904 9.05336 10.625 5.6709L10.625 9L9.125 9L9.125 4C9.125 3.58579 9.46079 3.25 9.875 3.25L14.875 3.25L14.875 4.75L11.835 4.75Z"/>
</mask>
<path d="M11.835 4.75C15.8871 8.68563 15.8871 15.3144 11.835 19.25L14.875 19.25L14.875 20.75L9.875 20.75C9.46079 20.75 9.125 20.4142 9.125 20L9.125 15L10.625 15L10.625 18.3291C14.2904 14.9466 14.2904 9.05336 10.625 5.6709L10.625 9L9.125 9L9.125 4C9.125 3.58579 9.46079 3.25 9.875 3.25L14.875 3.25L14.875 4.75L11.835 4.75Z" fill="black"/>
<path d="M11.835 4.75L11.835 3.75C11.4278 3.75 11.0614 3.99681 10.9083 4.37406C10.7553 4.75132 10.8462 5.18369 11.1382 5.46734L11.835 4.75ZM11.835 19.25L11.1382 18.5327C10.8462 18.8163 10.7553 19.2487 10.9083 19.6259C11.0614 20.0032 11.4278 20.25 11.835 20.25L11.835 19.25ZM14.875 19.25L15.875 19.25C15.875 18.6977 15.4273 18.25 14.875 18.25L14.875 19.25ZM14.875 20.75L14.875 21.75C15.4273 21.75 15.875 21.3023 15.875 20.75L14.875 20.75ZM9.875 20.75L9.875 19.75L9.875 19.75L9.875 20.75ZM9.125 20L8.125 20L8.125 20L9.125 20ZM9.125 15L9.125 14C8.57271 14 8.125 14.4477 8.125 15L9.125 15ZM10.625 15L11.625 15C11.625 14.4477 11.1773 14 10.625 14L10.625 15ZM10.625 18.3291L9.625 18.3291C9.625 18.7263 9.86005 19.0858 10.2239 19.2451C10.5877 19.4044 11.0113 19.3334 11.3032 19.064L10.625 18.3291ZM10.625 5.6709L11.3032 4.936C11.0113 4.66665 10.5877 4.59556 10.2239 4.75488C9.86005 4.9142 9.625 5.27373 9.625 5.6709L10.625 5.6709ZM10.625 9L10.625 10C11.1773 10 11.625 9.55228 11.625 9L10.625 9ZM9.125 9L8.125 9C8.125 9.55228 8.57271 10 9.125 10L9.125 9ZM9.125 4L8.125 4L8.125 4L9.125 4ZM9.875 3.25L9.875 4.25L9.875 4.25L9.875 3.25ZM14.875 3.25L15.875 3.25C15.875 2.69772 15.4273 2.25 14.875 2.25L14.875 3.25ZM14.875 4.75L14.875 5.75C15.4273 5.75 15.875 5.30228 15.875 4.75L14.875 4.75ZM11.835 4.75L11.1382 5.46734C14.786 9.01023 14.786 14.9898 11.1382 18.5327L11.835 19.25L12.5317 19.9673C16.9882 15.639 16.9882 8.36104 12.5317 4.03266L11.835 4.75ZM11.835 19.25L11.835 20.25L14.875 20.25L14.875 19.25L14.875 18.25L11.835 18.25L11.835 19.25ZM14.875 19.25L13.875 19.25L13.875 20.75L14.875 20.75L15.875 20.75L15.875 19.25L14.875 19.25ZM14.875 20.75L14.875 19.75L9.875 19.75L9.875 20.75L9.875 21.75L14.875 21.75L14.875 20.75ZM9.875 20.75L9.875 19.75C10.0131 19.75 10.125 19.8619 10.125 20L9.125 20L8.125 20C8.125 20.9665 8.9085 21.75 9.875 21.75L9.875 20.75ZM9.125 20L10.125 20L10.125 15L9.125 15L8.125 15L8.125 20L9.125 20ZM9.125 15L9.125 16L10.625 16L10.625 15L10.625 14L9.125 14L9.125 15ZM10.625 15L9.625 15L9.625 18.3291L10.625 18.3291L11.625 18.3291L11.625 15L10.625 15ZM10.625 18.3291L11.3032 19.064C15.3976 15.2856 15.3976 8.71444 11.3032 4.936L10.625 5.6709L9.94682 6.4058C13.1831 9.39228 13.1831 14.6077 9.94682 17.5942L10.625 18.3291ZM10.625 5.6709L9.625 5.6709L9.625 9L10.625 9L11.625 9L11.625 5.6709L10.625 5.6709ZM10.625 9L10.625 8L9.125 8L9.125 9L9.125 10L10.625 10L10.625 9ZM9.125 9L10.125 9L10.125 4L9.125 4L8.125 4L8.125 9L9.125 9ZM9.125 4L10.125 4C10.125 4.13807 10.0131 4.25 9.875 4.25L9.875 3.25L9.875 2.25C8.9085 2.25 8.125 3.0335 8.125 4L9.125 4ZM9.875 3.25L9.875 4.25L14.875 4.25L14.875 3.25L14.875 2.25L9.875 2.25L9.875 3.25ZM14.875 3.25L13.875 3.25L13.875 4.75L14.875 4.75L15.875 4.75L15.875 3.25L14.875 3.25ZM14.875 4.75L14.875 3.75L11.835 3.75L11.835 4.75L11.835 5.75L14.875 5.75L14.875 4.75Z" fill="white" mask="url(#path-1-outside-1_19_325)"/>
</svg>
`;

// In headless mode we dont have access to document, and also this feature is
// not used there.
let canvas: HTMLCanvasElement | undefined;
let globalCtx: CanvasRenderingContext2D | null = null;
if (!platform.isHeadlessMode) {
  canvas = document.createElement("canvas");
  globalCtx = canvas.getContext("2d", { willReadFrequently: true });
}

function drawRotatedImage(
  ctx: CanvasRenderingContext2D,
  dpi: number,
  img: HTMLImageElement,
  x: number,
  y: number,
  padding: number,
  angle: number,
) {
  if (!canvas) {
    return;
  }

  const width = (img.width + padding) * dpi;
  const height = (img.height + padding) * dpi;

  canvas.width = width;
  canvas.height = height;

  ctx.clearRect(0, 0, width, height);

  ctx.save();
  ctx.scale(dpi, dpi);
  ctx.translate(padding, padding);
  ctx.translate(x, y);
  ctx.rotate(angle);
  ctx.translate(-x, -y);
  ctx.drawImage(img, 0, 0);
  ctx.restore();

  return canvas.toDataURL("image/png");
}

function createIcon(
  content: string,
  originX: number,
  originY: number,
): {
  image: HTMLImageElement | null;
  cache: (string | undefined)[];
  originX: number;
  originY: number;
  lastDpi: number;
} {
  let image: HTMLImageElement | null = null;
  if (typeof Image !== "undefined") {
    image = new Image();
    image.src = `data:image/svg+xml;base64,${btoa(content)}`;
  }

  return {
    image: image,
    cache: new Array(64),
    originX: originX,
    originY: originY,
    lastDpi: 0,
  };
}

const icons = {
  rotate: createIcon(rotationHandleCursor, 12, 12),
  resize: createIcon(resizeHandleCursor, 10, 12),
};

export function getRotatedIconFor(
  name: keyof typeof icons,
  dirX: number,
  dirY: number,
  sourceRotation: number,
): string {
  if (!globalCtx) {
    return "default";
  }

  const icon = icons[name];
  if (!icon.image || !icon.image.complete) {
    return "default";
  }

  const dpi = platform.getDPI();
  if (icon.lastDpi !== dpi) {
    icon.cache.fill(undefined);
    icon.lastDpi = dpi;
  }

  const direction = math.rotateVector(dirX, dirY, sourceRotation);
  const rotation = math.normalizeAngle(Math.atan2(direction.y, direction.x));

  const index =
    Math.floor((rotation * icon.cache.length) / (Math.PI * 2)) %
    icon.cache.length;

  const padding = 2;

  let cursor = icon.cache[index];
  if (!cursor) {
    const image = drawRotatedImage(
      globalCtx,
      dpi,
      icon.image,
      icon.originX,
      icon.originY,
      padding,
      rotation,
    );
    cursor = `-webkit-image-set(url("${image}") 2x, url("${image}") 1x) ${icon.originX + padding} ${icon.originY + padding}, auto`;

    icon.cache[index] = cursor;
  }

  return cursor;
}
